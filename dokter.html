<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Dokter – EMR Klinik Dr. H. Dudi</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#f4f6f8}
header{background:#1976d2;color:#fff;padding:15px}
section{padding:20px}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
button{padding:8px 14px;border:none;border-radius:4px;cursor:pointer;background:#1976d2;color:#fff}
button.secondary{background:#388e3c}
button.info{background:#455a64}
button.danger{background:#d32f2f}
input,textarea{width:100%;padding:6px;margin-top:6px}
textarea{height:70px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;font-size:13px}
th{background:#e3f2fd}
.hidden{display:none}
.stat b{margin-right:10px}
</style>
</head>
<body>

<header>
  <h2>Dashboard Dokter</h2>
  <div>Klinik Dr. H. Dudi</div>
</header>

<section>

<!-- STATISTIK -->
<div class="card stat">
  <b>Antrian:</b> <span id="total">0</span>
  <b>Selesai:</b> <span id="selesai">0</span>
</div>

<!-- TABEL PASIEN -->
<div class="card">
  <h3>Antrian Pasien</h3>
  <table>
    <thead>
      <tr><th>No</th><th>Nama</th><th>Keluhan</th><th>Aksi</th></tr>
    </thead>
    <tbody id="antrian"></tbody>
  </table>
</div>

<!-- RIWAYAT -->
<div class="card hidden" id="riwayatCard">
  <h3>Riwayat Kunjungan</h3>
  <div id="riwayatNama"></div>
  <table>
    <thead>
      <tr><th>Tanggal</th><th>Dokter</th><th>Assessment</th><th>Detail</th></tr>
    </thead>
    <tbody id="riwayatData"></tbody>
  </table>
  <button class="danger" onclick="tutupRiwayat()">Tutup</button>
</div>

<!-- SKRINING -->
<div class="card hidden" id="skriningCard">
  <h3>Skrining Awal Perawat</h3>
  <input type="hidden" id="skriningKey">
  <label>Tekanan Darah</label><input id="td">
  <label>Nadi</label><input id="nadi">
  <label>Suhu</label><input id="suhu">
  <label>Respirasi</label><input id="rr">
  <label>Keluhan Utama</label><textarea id="keluhanAwal"></textarea>
  <br><br>
  <button class="secondary" onclick="simpanSkrining()">Simpan Skrining</button>
  <button class="danger" onclick="tutupSkrining()">Batal</button>
</div>

<!-- SOAP -->
<div class="card hidden" id="soapCard">
  <h3>Pemeriksaan Medis (SOAP)</h3>
  <input type="hidden" id="pasienKey">
  <label>Subjective</label><textarea id="S"></textarea>
  <label>Objective</label><textarea id="O"></textarea>
  <label>Assessment</label><textarea id="A"></textarea>
  <label>Plan</label><textarea id="P"></textarea>
  <br><br>
  <button onclick="simpanSOAP()">Simpan Rekam Medis</button>
  <button class="secondary" onclick="cetakResume()">Cetak Resume</button>
  <button class="danger" onclick="tutupSOAP()">Batal</button>
</div>

</section>

<script>
/* ======================
   STEP 1 – KEAMANAN LOGIN
====================== */
if(sessionStorage.getItem('login')!=='true' || sessionStorage.getItem('role')!=='dokter'){
  location.href='index.html';
}

/* ======================
   STEP 2 – FIREBASE INIT
====================== */
const firebaseConfig={
  databaseURL:"https://develop-program-erm-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}
const db=firebase.database();

/* ======================
   GLOBAL
====================== */
let namaPasienAktif='';

/* ======================
   STEP 3 – LOAD ANTRIAN
====================== */
function loadAntrian(){
  db.ref('antrian').on('value',snap=>{
    let html='',no=1,selesai=0;
    snap.forEach(d=>{
      const v=d.val();
      if(v.status==='selesai') selesai++;
      if(v.status!=='selesai'){
        html+=`
        <tr>
          <td>${no++}</td>
          <td>${v.nama}</td>
          <td>${v.keluhan}</td>
          <td>
            <button onclick="bukaSkrining('${d.key}','${v.nama}')">Skrining</button>
            <button class="info" onclick="lihatRiwayat('${d.key}','${v.nama}')">Riwayat</button>
          </td>
        </tr>`;
      }
    });
    document.getElementById('antrian').innerHTML=html;
    document.getElementById('total').innerText=snap.size;
    document.getElementById('selesai').innerText=selesai;
  });
}
loadAntrian();

/* ======================
   STEP 4 – RIWAYAT
====================== */
function lihatRiwayat(key,nama){
  riwayatNama.innerHTML='<b>Pasien:</b> '+nama;
  riwayatData.innerHTML='';
  db.ref('rekam_medis/'+key).once('value',s=>{
    s.forEach(d=>{
      const v=d.val();
      riwayatData.innerHTML+=`
      <tr>
        <td>${v.tanggal}</td>
        <td>${v.dokter}</td>
        <td>${v.assessment}</td>
        <td><button onclick="detailSOAP('${key}','${d.key}')">Detail</button></td>
      </tr>`;
    });
  });
  riwayatCard.classList.remove('hidden');
}
function detailSOAP(pk,sk){
  db.ref('rekam_medis/'+pk+'/'+sk).once('value',s=>{
    const v=s.val();
    alert(`Subjective:\n${v.subjective}\n\nObjective:\n${v.objective}\n\nAssessment:\n${v.assessment}\n\nPlan:\n${v.plan}`);
  });
}
function tutupRiwayat(){riwayatCard.classList.add('hidden');}

/* ======================
   STEP 5 – SKRINING
====================== */
function bukaSkrining(key,nama){
  namaPasienAktif=nama;
  skriningKey.value=key;
  skriningCard.classList.remove('hidden');
}
function tutupSkrining(){skriningCard.classList.add('hidden');}
function simpanSkrining(){
  const key=skriningKey.value;
  db.ref('skrining/'+key).push({
    td:td.value,nadi:nadi.value,suhu:suhu.value,rr:rr.value,
    keluhan:keluhanAwal.value,
    waktu:new Date().toLocaleString('id-ID')
  });
  tutupSkrining();
  periksa(key,namaPasienAktif);
}

/* ======================
   STEP 6 – SOAP
====================== */
function periksa(key,nama){
  namaPasienAktif=nama;
  pasienKey.value=key;
  soapCard.classList.remove('hidden');
}
function tutupSOAP(){soapCard.classList.add('hidden');}

function simpanSOAP(){
  const key=pasienKey.value;
  db.ref('rekam_medis/'+key).push({
    subjective:S.value,
    objective:O.value,
    assessment:A.value,
    plan:P.value,
    dokter:'Dr. H. Dudi',
    tanggal:new Date().toLocaleString('id-ID')
  });
  db.ref('antrian/'+key).update({status:'selesai'});
  alert('Rekam medis berhasil disimpan');
  tutupSOAP();
}

/* ======================
   STEP 7 – CETAK RESUME
====================== */
function cetakResume(){
  const w=window.open('','','width=800,height=600');
  w.document.write(`
  <html><body style="font-family:Arial">
  <h2 style="text-align:center">RESUME MEDIS</h2>
  <p><b>Klinik:</b> Klinik Dr. H. Dudi</p>
  <p><b>Nama Pasien:</b> ${namaPasienAktif}</p>
  <hr>
  <p><b>Subjective</b><br>${S.value}</p>
  <p><b>Objective</b><br>${O.value}</p>
  <p><b>Assessment</b><br>${A.value}</p>
  <p><b>Plan</b><br>${P.value}</p>
  <br><br>
  <p style="text-align:right"><b>Dr. H. Dudi</b></p>
  <script>window.print()</script>
  </body></html>`);
  w.document.close();
}
</script>

</body>
</html>
