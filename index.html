<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>EMR Klinik H. Dudi â€“ DEMO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f9}
header{background:#0d6efd;color:#fff;padding:12px}
nav{background:#fff;padding:10px;display:flex;gap:10px}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.card{background:#fff;margin:10px;padding:15px;border-radius:10px}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #ddd}
input,select,textarea{width:100%;padding:8px;margin:5px 0}
</style>
</head>

<body>

<header>
<h2>EMR Klinik H. Dudi (DEMO)</h2>
</header>

<nav id="menu"></nav>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="card">
<h3>Dashboard</h3>
<p>Total Kunjungan: <b id="totalKunjungan">0</b></p>
<p>Menunggu: <b id="menunggu">0</b></p>
<p>Selesai: <b id="selesai">0</b></p>
<canvas id="grafikKunjungan"></canvas>
</div>

<!-- ================= PENDAFTARAN ================= -->
<div id="pendaftaran" class="card hidden">
<h3>Pendaftaran Rekam Medis</h3>

<label>No RM</label>
<input id="noRM" placeholder="Otomatis">

<label>Nama Lengkap</label>
<input id="namaPasien">

<label>NIK</label>
<input id="nik">

<label>Jenis Kelamin</label>
<select id="jk"><option>L</option><option>P</option></select>

<label>Tanggal Lahir</label>
<input type="date" id="tglLahir">

<label>Usia</label>
<input id="usia" readonly>

<label>Alamat</label>
<input id="alamat">

<label>No Telp</label>
<input id="telp">

<label>Jenis Pasien</label>
<select id="jenisPasien"><option>UMUM</option><option>BPJS</option></select>

<label>No BPJS / Asuransi</label>
<input id="noBPJS">

<label>Poli Tujuan</label>
<input id="poli">

<button onclick="daftarPasien()">Daftarkan Pasien</button>
</div>

<!-- ================= PERAWAT ================= -->
<div id="perawat" class="card hidden">
<h3>Perawat</h3>
<table>
<tbody id="tabelPerawat"></tbody>
</table>
</div>

<div id="anamnesa" class="card hidden">
<h3>Anamnesa</h3>
<p id="infoPerawat"></p>
<p id="infoRM"></p>
<textarea placeholder="Anamnesa"></textarea>
<button onclick="simpanAnamnesa()">Kirim ke Dokter</button>
</div>

<!-- ================= DOKTER ================= -->
<div id="dokter" class="card hidden">
<h3>Dokter</h3>
<table>
<tbody id="tabelDokter"></tbody>
</table>
</div>

<div id="soap" class="card hidden">
<h3>SOAP Dokter</h3>
<p id="infoDokter"></p>
<p id="waktuPeriksa"></p>

<textarea id="soapS" placeholder="S"></textarea>
<textarea id="soapO" placeholder="O"></textarea>
<textarea id="soapA" placeholder="A"></textarea>
<textarea id="soapP" placeholder="P"></textarea>

<input id="diagnosis" placeholder="Diagnosis">
<input id="tindakan" placeholder="Tindakan">
<textarea id="resep" placeholder="Resep"></textarea>

<button onclick="simpanSOAP()">Selesai Dokter</button>
</div>

<!-- ================= FARMASI ================= -->
<div id="farmasi" class="card hidden">
<h3>Farmasi</h3>
<table>
<tbody id="tabelFarmasi"></tbody>
</table>
</div>

<div id="detailFarmasi" class="card hidden">
<h3>Detail Farmasi</h3>
<p id="infoFarmasi"></p>
<textarea id="resepFarmasi"></textarea>
<button onclick="selesaiFarmasi()">Selesai</button>
</div>

<!-- ==================== SCRIPT ==================== -->
<script>
firebase.initializeApp({
  databaseURL:"https://develop-program-erm-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

const menu=document.getElementById('menu');
const grafikKunjungan=document.getElementById('grafikKunjungan');

let pasienAktif=null, chart=null;

/* ==================== ROLE & NAV ==================== */
setRole('pendaftaran');
function setRole(r){
menu.innerHTML='';
add('Dashboard','dashboard');
add('Pendaftaran','pendaftaran');
add('Perawat','perawat');
add('Dokter','dokter');
add('Farmasi','farmasi');
show('dashboard');
}
function add(l,i){
let b=document.createElement('button');
b.innerText=l;b.onclick=()=>show(i);menu.appendChild(b);
}
function show(i){
document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
document.getElementById(i).classList.remove('hidden');
if(i==='pendaftaran'){setAutoRM();usia.value='';}
}

/* ==================== RM & USIA ==================== */
function generateRM(){return 'RM'+Date.now().toString().slice(-6);}
function setAutoRM(){if(!noRM.value) noRM.value=generateRM();}

tglLahir.addEventListener('change',()=>{
const lahir=new Date(tglLahir.value);
const now=new Date();
let u=now.getFullYear()-lahir.getFullYear();
if(now.getMonth()<lahir.getMonth()||now.getMonth()==lahir.getMonth()&&now.getDate()<lahir.getDate())u--;
usia.value=(u<0?0:u)+' Tahun';
});

/* ==================== PENDAFTARAN ==================== */
function daftarPasien(){
const rm=noRM.value||generateRM();
const antrian='A'+Math.floor(Math.random()*900);
db.ref('kunjungan_hari_ini').push({
rm,nama:namaPasien.value,nik,jk,tgl_lahir:tglLahir.value,
usia:usia.value,alamat,telp,jenis_pasien:jenisPasien.value,
no_bpjs:noBPJS.value,poli,antrian,status:'menunggu_perawat'
});
alert(`Terdaftar\nRM:${rm}\nAntrian:${antrian}`);
show('dashboard');
}

/* ==================== REALTIME ==================== */
db.ref('kunjungan_hari_ini').on('value',s=>{
let stat={mp:0,md:0,sd:0};
tabelPerawat.innerHTML=tabelDokter.innerHTML=tabelFarmasi.innerHTML='';
s.forEach(c=>{
let d=c.val();

if(d.status==='menunggu_perawat'){
stat.mp++;
let r=document.createElement('tr');
r.innerHTML=`<td>${d.antrian}</td><td>${d.nama}</td>`;
r.onclick=()=>{pasienAktif={k:c.key};infoPerawat.innerText=d.nama;infoRM.innerText=d.rm;show('anamnesa');};
tabelPerawat.appendChild(r);
}

if(d.status==='menunggu_dokter'){
stat.md++;
let r=document.createElement('tr');
r.innerHTML=`<td>${d.antrian}</td><td>${d.nama}</td>`;
r.onclick=()=>{pasienAktif={k:c.key};infoDokter.innerText=d.nama;waktuPeriksa.innerText=new Date().toLocaleString('id-ID');show('soap');};
tabelDokter.appendChild(r);
}

if(d.status==='selesai_dokter'){
stat.sd++;
let r=document.createElement('tr');
r.innerHTML=`<td>${d.antrian}</td><td>${d.nama}</td>`;
r.onclick=()=>{pasienAktif={k:c.key};infoFarmasi.innerText=d.nama;resepFarmasi.value=d.resep||'';show('detailFarmasi');};
tabelFarmasi.appendChild(r);
}
});
totalKunjungan.innerText=s.size;
menunggu.innerText=stat.mp+stat.md;
selesai.innerText=stat.sd;
updateChart(stat);
});

/* ==================== CHART ==================== */
function updateChart(s){
if(chart)chart.destroy();
chart=new Chart(grafikKunjungan,{
type:'bar',
data:{labels:['Perawat','Dokter','Selesai'],datasets:[{data:[s.mp,s.md,s.sd]}]},
options:{plugins:{legend:{display:false}}}
});
}

/* ==================== FLOW ==================== */
function simpanAnamnesa(){
db.ref(`kunjungan_hari_ini/${pasienAktif.k}/status`).set('menunggu_dokter');
show('perawat');
}
function simpanSOAP(){
db.ref(`kunjungan_hari_ini/${pasienAktif.k}`).update({
soap:{S:soapS.value,O:soapO.value,A:soapA.value,P:soapP.value},
diagnosis:diagnosis.value,tindakan:tindakan.value,resep:resep.value,
status:'selesai_dokter'
});
show('dokter');
}
function selesaiFarmasi(){
db.ref(`kunjungan_hari_ini/${pasienAktif.k}/status`).set('selesai_farmasi');
show('farmasi');
}
</script>

</body>
</html>
