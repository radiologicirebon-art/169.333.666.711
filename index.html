<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>EMR Klinik - Antrian & SOAP</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
.hidden{display:none}
header{background:#0b5ed7;color:#fff;padding:14px;text-align:center}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:14px;margin-bottom:15px}
input,textarea,button{width:100%;padding:10px;margin-top:6px}
button{background:#0b5ed7;color:#fff;border:none;border-radius:8px;cursor:pointer}
.list{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.list:hover{background:#f0f4ff}
.badge{padding:4px 8px;border-radius:6px;font-size:12px}
.wait{background:orange;color:#fff}
.call{background:green;color:#fff}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
<div class="card">
<h3 align="center">LOGIN EMR</h3>
<input id="username" placeholder="Username">
<input id="pin" type="password" placeholder="PIN">
<button onclick="login()">LOGIN</button>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden">
<header>EMR KLINIK – PENDAFTARAN, ANTRIAN & SOAP</header>
<div class="container">

<div class="card">
Login: <b id="userName"></b> | Role: <b id="userRole"></b>
</div>

<div id="menu" class="card"></div>

<!-- PENDAFTARAN -->
<div id="daftarPage" class="card hidden">
<h3>Pendaftaran Pasien</h3>
<input id="nama" placeholder="Nama Pasien">
<input id="tgl" type="date">
<button onclick="simpanPasien()">SIMPAN & MASUK ANTRIAN</button>
</div>

<!-- ANTRIAN DOKTER -->
<div id="antrianPage" class="card hidden">
<h3>Antrian Pasien</h3>
<div id="listAntrian"></div>
</div>

<!-- SOAP -->
<div id="soapPage" class="card hidden">
<h3>SOAP – <span id="soapNama"></span></h3>
<textarea id="S" placeholder="Subjective"></textarea>
<textarea id="O" placeholder="Objective"></textarea>
<textarea id="A" placeholder="Assessment"></textarea>
<textarea id="P" placeholder="Plan"></textarea>
<button onclick="simpanSOAP()">SIMPAN SOAP</button>
</div>

<button onclick="logout()">LOGOUT</button>

</div>
</div>

<script>
/* USER */
const USERS={
  "dokter":{pin:"123",role:"Dokter"},
  "daftar":{pin:"123",role:"Pendaftaran"}
};

/* FIREBASE */
firebase.initializeApp({
  databaseURL:"https://develop-program-erm-default-rtdb.asia-southeast1.firebasedatabase.app/"
});
const db=firebase.database();

/* LOGIN */
function login(){
  if(USERS[username.value] && USERS[username.value].pin===pin.value){
    localStorage.setItem("user",username.value);
    showDashboard();
  } else alert("Username / PIN salah");
}

/* DASHBOARD */
function showDashboard(){
  loginPage.classList.add("hidden");
  dashboardPage.classList.remove("hidden");

  const u=localStorage.getItem("user");
  userName.innerText=u;
  userRole.innerText=USERS[u].role;

  let m="";
  if(USERS[u].role==="Pendaftaran"){
    m+=`<button onclick="openDaftar()">Pendaftaran Pasien</button>`;
  }
  if(USERS[u].role==="Dokter"){
    m+=`<button onclick="openAntrian()">Panggil Antrian</button>`;
  }
  menu.innerHTML=m;
}

/* PENDAFTARAN */
function openDaftar(){
  hideAll();
  daftarPage.classList.remove("hidden");
}
function simpanPasien(){
  if(!nama.value){alert("Nama wajib diisi");return;}
  const rm="RM"+Date.now();
  db.ref("pasien/"+rm).set({
    nama:nama.value,
    tgl:tgl.value,
    status:"MENUNGGU",
    waktu:new Date().toISOString()
  });
  alert("Pasien berhasil masuk antrian");
  nama.value=""; tgl.value="";
}

/* ANTRIAN */
let currentRM="";
function openAntrian(){
  hideAll();
  antrianPage.classList.remove("hidden");
  loadAntrian();
}
function loadAntrian(){
  listAntrian.innerHTML="";
  db.ref("pasien").orderByChild("status").equalTo("MENUNGGU")
  .off();
  db.ref("pasien").orderByChild("status").equalTo("MENUNGGU")
  .on("child_added",snap=>{
    const d=snap.val();
    listAntrian.innerHTML+=`
      <div class="list" onclick="panggil('${snap.key}','${d.nama}')">
        ${d.nama}
        <span class="badge wait">MENUNGGU</span>
      </div>`;
  });
}
function panggil(rm,nama){
  currentRM=rm;
  db.ref("pasien/"+rm+"/status").set("DIPANGGIL");
  openSOAP(nama);
}

/* SOAP */
function openSOAP(nama){
  hideAll();
  soapPage.classList.remove("hidden");
  soapNama.innerText=nama;
}
function simpanSOAP(){
  if(!currentRM){alert("RM tidak ditemukan");return;}
  const t=new Date().toISOString();
  db.ref("soap/"+currentRM+"/"+t).set({
    S:S.value,O:O.value,A:A.value,P:P.value,
    dokter:localStorage.getItem("user")
  });
  db.ref("pasien/"+currentRM+"/status").set("SELESAI");
  alert("SOAP berhasil disimpan");
  S.value=O.value=A.value=P.value="";
}

/* UTIL */
function hideAll(){
  daftarPage.classList.add("hidden");
  antrianPage.classList.add("hidden");
  soapPage.classList.add("hidden");
}
function logout(){
  localStorage.clear();
  location.reload();
}
if(localStorage.getItem("user")) showDashboard();
</script>

</body>
</html>
