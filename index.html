<!--
EMR KLINIK UTAMA – PROFESSIONAL MODE
TAHAP 2A + 2B
MASTER PASIEN & KUNJUNGAN (CORE KLINIK)
MENIRU STRUKTUR SISTEM KLINIK PHP
-->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EMR Klinik Utama | Pasien & Kunjungan</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#eef2f7;margin:0}
header{background:#0d47a1;color:#fff;padding:14px 20px;font-size:18px}
.container{padding:24px;max-width:1100px;margin:auto}
.card{background:#fff;border-radius:10px;padding:22px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:20px}
input,select,button{padding:10px;width:100%;margin-top:10px}
button{background:#0d47a1;color:#fff;border:none;border-radius:6px;cursor:pointer}
button:hover{opacity:.9}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px}
th{background:#e3f2fd}
</style>
</head>
<body>
<header>EMR KLINIK UTAMA – MASTER PASIEN & KUNJUNGAN</header>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>Login Sistem</h3>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- CORE -->
<div class="card hidden" id="coreBox">
  <h3>Master Pasien</h3>
  <input id="nama" placeholder="Nama Pasien">
  <input id="nik" placeholder="NIK">
  <input id="tgl" type="date">
  <select id="jk"><option>L</option><option>P</option></select>
  <input id="alamat" placeholder="Alamat">
  <button onclick="simpanPasien()">Simpan Pasien</button>
</div>

<div class="card hidden" id="kunjunganBox">
  <h3>Registrasi Kunjungan</h3>
  <input id="rmKunjungan" placeholder="No RM">
  <input id="poli" placeholder="Poli">
  <input id="dokter" placeholder="Dokter">
  <button onclick="buatKunjungan()">Buat Kunjungan</button>
</div>

<div class="card hidden" id="listBox">
  <h3>Daftar Kunjungan</h3>
  <table>
    <thead><tr><th>No RM</th><th>Nama</th><th>Poli</th><th>Dokter</th><th>Status</th></tr></thead>
    <tbody id="kunjunganTable"></tbody>
  </table>
</div>

</div>

<script>
/************************************************
 * AUTO USER GENERATOR (ROLE-BASED)
 * Username & Password dibuat otomatis
 ************************************************/
const firebaseConfig={databaseURL:"https://develop-program-erm-default-rtdb.asia-southeast1.firebasedatabase.app/"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

// ===== AUTO USER GENERATOR =====
function generateCredential(role){
  const ts = Date.now().toString().slice(-4);
  const username = role.toLowerCase()+ts+'@klinik.com';
  const password = role.toLowerCase()+ts;
  return {username,password};
}

// CREATE USER PER ROLE (ADMIN ONLY – tahap awal)
function createUser(role,nama){
  const cred = generateCredential(role);
  auth.createUserWithEmailAndPassword(cred.username,cred.password)
  .then(res=>{
    const uid=res.user.uid;
    db.ref('users/'+uid).set({
      nama:nama,
      role:role,
      aktif:true
    });
    alert(`USER DIBUAT\nRole: ${role}\nUsername: ${cred.username}\nPassword: ${cred.password}`);
  })
  .catch(e=>alert(e.message));
}


function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));}

auth.onAuthStateChanged(user=>{
 if(!user)return;
 loginBox.classList.add('hidden');
 coreBox.classList.remove('hidden');
 kunjunganBox.classList.remove('hidden');
 listBox.classList.remove('hidden');
 loadKunjungan();
});

function generateRM(){return 'RM'+Date.now();}

function simpanPasien(){
 const rm=generateRM();
 const data={rm,nama:nama.value,nik:nik.value,tgl_lahir:tgl.value,jk:jk.value,alamat:alamat.value};
 db.ref('pasien/'+rm).set(data);
 alert('Pasien tersimpan dengan RM: '+rm);
}

function buatKunjungan(){
 const id=db.ref('kunjungan').push().key;
 const data={no_rm:rmKunjungan.value,poli:poli.value,dokter:dokter.value,tanggal:new Date().toISOString(),status:'TERDAFTAR'};
 db.ref('kunjungan/'+id).set(data);
}

function loadKunjungan(){
 db.ref('kunjungan').on('value',snap=>{
  kunjunganTable.innerHTML='';
  snap.forEach(s=>{
    const d=s.val();
    kunjunganTable.innerHTML+=`<tr><td>${d.no_rm}</td><td>-</td><td>${d.poli}</td><td>${d.dokter}</td><td>${d.status}</td></tr>`;
  });
 });
}
</script>
</body>
</html>
