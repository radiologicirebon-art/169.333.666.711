<!--
=====================================================
 STEP 5 ‚Äì RIWAYAT KUNJUNGAN PASIEN (MEDICAL HISTORY)
 Klinik Dokter Umum (Dr. H. Dudi)
 Database:
 https://develop-program-erm-default-rtdb.asia-southeast1.firebasedatabase.app/

 CATATAN PENTING:
 ‚úî STEP 1‚Äì4C TETAP UTUH
 ‚úî Tidak ada fungsi dihapus
 ‚úî STEP 5 MENAMBAHKAN riwayat medis per pasien
=====================================================
-->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Dokter ‚Äì EMR Klinik Dr. H. Dudi</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
header { background:#1976d2; color:white; padding:15px; }
section { padding:20px; }
.card { background:white; padding:15px; border-radius:6px; margin-bottom:15px; }
button { padding:8px 14px; background:#1976d2; color:white; border:none; border-radius:4px; cursor:pointer; }
button.secondary { background:#388e3c; }
button.info { background:#455a64; }
button.danger { background:#d32f2f; }
input, textarea { width:100%; margin-top:6px; padding:6px; }
textarea { height:70px; }
table { width:100%; border-collapse:collapse; }
th,td { border:1px solid #ccc; padding:8px; }
th { background:#e3f2fd; }
.hidden { display:none; }
</style>
</head>
<body>

<header>
  <h2>Dashboard Dokter</h2>
  <div>Klinik Dr. H. Dudi</div>
</header>

<section>

<!-- STATISTIK -->
<div class="card">
  <b>Antrian Hari Ini:</b> <span id="total">0</span> |
  <b>Selesai:</b> <span id="selesai">0</span>
</div>

<!-- TABEL PASIEN -->
<div class="card">
  <h3>Antrian Pasien</h3>
  <table>
    <thead>
      <tr><th>No</th><th>Nama</th><th>Keluhan</th><th>Aksi</th></tr>
    </thead>
    <tbody id="antrian"></tbody>
  </table>
</div>

<!-- RIWAYAT PASIEN -->
<div class="card hidden" id="riwayatCard">
  <h3>Riwayat Kunjungan Pasien</h3>
  <div id="riwayatNama"></div>
  <table>
    <thead>
      <tr><th>Tanggal</th><th>Dokter</th><th>Assessment</th><th>Detail</th></tr>
    </thead>
    <tbody id="riwayatData"></tbody>
  </table>
  <button class="danger" onclick="tutupRiwayat()">Tutup</button>
</div>

<!-- FORM SKRINING PERAWAT -->
<div class="card hidden" id="skriningCard">
  <h3>Skrining Awal Perawat (TTV)</h3>
  <input type="hidden" id="skriningKey">
  <label>Tekanan Darah</label>
  <input id="td" placeholder="120/80 mmHg">
  <label>Nadi</label>
  <input id="nadi" placeholder="x/menit">
  <label>Suhu</label>
  <input id="suhu" placeholder="¬∞C">
  <label>Respirasi</label>
  <input id="rr" placeholder="x/menit">
  <label>Keluhan Utama</label>
  <textarea id="keluhanAwal"></textarea>
  <br><br>
  <button class="secondary" onclick="simpanSkrining()">üíæ Simpan Skrining</button>
  <button class="danger" onclick="tutupSkrining()">Batal</button>
</div>

<!-- FORM SOAP -->
<div class="card hidden" id="soapCard">
  <h3>Pemeriksaan Medis (SOAP)</h3>
  <input type="hidden" id="pasienKey">
  <label>Subjective</label>
  <textarea id="S"></textarea>
  <label>Objective</label>
  <textarea id="O"></textarea>
  <label>Assessment</label>
  <textarea id="A"></textarea>
  <label>Plan</label>
  <textarea id="P"></textarea>
  <br><br>
  <button onclick="simpanSOAP()">üíæ Simpan Rekam Medis</button>
  <button class="secondary" onclick="cetakResume()">üñ®Ô∏è Cetak Resume Medis</button>
  <button class="danger" onclick="tutupSOAP()">Batal</button>
</div>

</section>

<script>
/* ======================
   KEAMANAN LOGIN
====================== */
if(sessionStorage.getItem('login') !== 'true' || sessionStorage.getItem('role') !== 'dokter'){
  location.href = 'index.html';
}

/* ======================
   FIREBASE INIT
====================== */
const firebaseConfig = {
  databaseURL: "https://develop-program-erm-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ======================
   LOAD ANTRIAN
====================== */
function loadAntrian(){
  db.ref('antrian').on('value', snap => {
    let html = '';
    let no = 1;
    let selesai = 0;
    snap.forEach(d => {
      const v = d.val();
      if(v.status === 'selesai') selesai++;
      if(v.status !== 'selesai'){
        html += `<tr>
          <td>${no++}</td>
          <td>${v.nama}</td>
          <td>${v.keluhan}</td>
          <td>
            <button onclick="bukaSkrining('${d.key}','${v.nama}')">Skrining</button>
            <button class="info" onclick="lihatRiwayat('${d.key}','${v.nama}')">Riwayat</button>
          </td>
        </tr>`;
      }
    });
    document.getElementById('antrian').innerHTML = html;
    document.getElementById('total').innerText = snap.size;
    document.getElementById('selesai').innerText = selesai;
  });
}
loadAntrian();

/* ======================
   STEP 5 ‚Äì RIWAYAT PASIEN
====================== */
function lihatRiwayat(key,nama){
  document.getElementById('riwayatNama').innerHTML = `<b>Pasien:</b> ${nama}`;
  const tbody = document.getElementById('riwayatData');
  tbody.innerHTML = '';
  db.ref('rekam_medis/' + key).once('value', snap => {
    snap.forEach(d => {
      const v = d.val();
      tbody.innerHTML += `<tr>
        <td>${v.tanggal}</td>
        <td>${v.dokter}</td>
        <td>${v.assessment}</td>
        <td><button onclick=\"detailSOAP('${key}','${d.key}')\">Detail</button></td>
      </tr>`;
    });
  });
  document.getElementById('riwayatCard').classList.remove('hidden');
}

function detailSOAP(pasienKey,soapKey){
  db.ref('rekam_medis/' + pasienKey + '/' + soapKey).once('value', s => {
    const v = s.val();
    alert(`Subjective:\n${v.subjective}\n\nObjective:\n${v.objective}\n\nAssessment:\n${v.assessment}\n\nPlan:\n${v.plan}`);
  });
}

function tutupRiwayat(){
  document.getElementById('riwayatCard').classList.add('hidden');
}

/* ======================
   STEP 4C ‚Äì SKRINING
====================== */
let namaPasienAktif = '';
function bukaSkrining(key,nama){
  namaPasienAktif = nama;
  skriningKey.value = key;
  skriningCard.classList.remove('hidden');
}

function tutupSkrining(){ skriningCard.classList.add('hidden'); }

function simpanSkrining(){
  const key = skriningKey.value;
  db.ref('skrining/' + key).push({
    td: td.value,
    nadi: nadi.value,
    suhu: suhu.value,
    rr: rr.value,
    keluhan: keluhanAwal.value,
    waktu: new Date().toLocaleString('id-ID')
  });
  tutupSkrining();
  periksa(key,namaPasienAktif);
}

/* ======================
   STEP 3 ‚Äì SOAP
====================== */
function periksa(key,nama){
  namaPasienAktif = nama;
  pasienKey.value = key;
  soapCard.classList.remove('hidden');
}

function tutupSOAP(){ soapCard.classList.add('hidden'); }

/* ======================
   STEP 4A ‚Äì SIMPAN SOAP
====================== */
function simpanSOAP(){
  const key = pasienKey.value;
  db.ref('rekam_medis/' + key).push({
    subjective: S.value,
    objective: O.value,
    assessment: A.value,
    plan: P.value,
    dokter: 'Dr. H. Dudi',
    tanggal: new Date().toLocaleString('id-ID')
  });
  db.ref('antrian/' + key).update({ status: 'selesai' });
  alert('Rekam medis tersimpan');
  tutupSOAP();
}

/* ======================
   STEP 4B ‚Äì CETAK RESUME
====================== */
function cetakResume(){
  const w = window.open('', '', 'width=800,height=600');
  w.document.write(`<html><body style="font-family:Arial">
  <h2 style="text-align:center">RESUME MEDIS</h2>
  <p><b>Klinik:</b> Klinik Dr. H. Dudi</p>
  <p><b>Pasien:</b> ${namaPasienAktif}</p>
  <hr>
  <p><b>Subjective</b><br>${S.value}</p>
  <p><b>Objective</b><br>${O.value}</p>
  <p><b>Assessment</b><br>${A.value}</p>
  <p><b>Plan</b><br>${P.value}</p>
  <br><br><p style="text-align:right"><b>Dr. H. Dudi</b></p>
  <script>window.print()</script></body></html>`);
  w.document.close();
}
</script>

</body>
</html>

